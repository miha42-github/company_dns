from fastapi import FastAPI, Path, HTTPException, Request
from fastapi.responses import JSONResponse, RedirectResponse, FileResponse
from fastapi.staticfiles import StaticFiles
from fastapi.middleware.cors import CORSMiddleware
from slowapi.errors import RateLimitExceeded
import uvicorn
import logging
import asyncio
import os
from pathlib import Path as PathLib
from datetime import datetime

from lib.sic import SICQueries
from lib.edgar import EdgarQueries
from lib.wikipedia import WikipediaQueries
from lib.firmographics import GeneralQueries
from lib.uk_sic import UKSICQueries
from lib.international_sic import InternationalSICQueries
from lib.eu_sic import EuSICQueries
from lib.japan_sic import JapanSICQueries
from lib.unified_sic import UnifiedSICQueries
from lib.security_middleware import security_middleware
from lib.logging_config import logging_middleware, logger, configure_logging
from lib.rate_limiter import limiter, rate_limit_error_handler
from lib.models import (
    SICResponse, DivisionResponse, UKSICResponse, ISICResponse,
    EUSICResponse, JapanSICResponse, UnifiedSICResponse,
    EdgarCIKResponse, EdgarDetailResponse, WikipediaResponse,
    MergedFirmographicsResponse, ErrorResponse, HealthCheckResponse
)
# -------------------------------------------------------------- #
# BEGIN: Standard Industry Classification (SIC) database cache functions
@app.get(
    "/V2.0/sic/description/{sic_desc}",
    response_model=SICResponse,
    tags=["SIC - US (V2.0)"],
    summary="Get SIC codes by description"
)
@app.get(
    "/V3.0/na/sic/description/{sic_desc}",
    response_model=SICResponse,
    tags=["SIC - US (V3.0)"],
    summary="Get SIC codes by description"
)
async def sic_description(sic_desc: str = Path(..., min_length=2, description="SIC description to search")):
    return await _handle_request(sq, sq.get_all_sic_by_name, sic_desc)

@app.get(
    "/V2.0/sic/code/{sic_code}",
    response_model=SICResponse,
    tags=["SIC - US (V2.0)"],
    summary="Get SIC by code"
)
@app.get(
    "/V3.0/na/sic/code/{sic_code}",
    response_model=SICResponse,
    tags=["SIC - US (V3.0)"],
    summary="Get SIC by code"
)
async def sic_code(sic_code: str = Path(..., description="SIC code number")):
    return await _handle_request(sq, sq.get_all_sic_by_no, sic_code)

@app.get(
    "/V2.0/sic/division/{division_code}",
    response_model=DivisionResponse,
    tags=["SIC - US (V2.0)"],
    summary="Get division by code"
)
@app.get(
    "/V3.0/na/sic/division/{division_code}",
    response_model=DivisionResponse,
    tags=["SIC - US (V3.0)"],
    summary="Get division by code"
)
async def division_code(division_code: str = Path(..., description="Division code")):
    return await _handle_request(sq, sq.get_division_desc_by_id, division_code)

@app.get(
    "/V2.0/sic/industry/{industry_code}",
    response_model=SICResponse,
    tags=["SIC - US (V2.0)"],
    summary="Get industry group by code"
)
@app.get(
    "/V3.0/na/sic/industry/{industry_code}",
    response_model=SICResponse,
    tags=["SIC - US (V3.0)"],
    summary="Get industry group by code"
)
async def industry_code(industry_code: str = Path(..., description="Industry code")):
    return await _handle_request(sq, sq.get_all_industry_group_by_no, industry_code)

@app.get(
    "/V2.0/sic/major/{major_code}",
    response_model=SICResponse,
    tags=["SIC - US (V2.0)"],
    summary="Get major group by code"
)
@app.get(
    "/V3.0/na/sic/major/{major_code}",
    response_model=SICResponse,
    tags=["SIC - US (V3.0)"],
    summary="Get major group by code"
)
async def major_code(major_code: str = Path(..., description="Major group code")):
    return await _handle_request(sq, sq.get_all_major_group_by_no, major_code)
# END: Standard Industry Classification (SIC) database cache functions
# -------------------------------------------------------------- #

# -------------------------------------------------------------- #
# BEGIN: UK Standard Industry Classification (SIC) database cache functions
@app.get(
    "/V3.0/uk/sic/description/{uk_sic_desc}",
    response_model=UKSICResponse,
    tags=["SIC - UK (V3.0)"],
    summary="Get UK SIC by description"
)
async def uk_sic_description(uk_sic_desc: str = Path(..., min_length=2, description="UK SIC description")):
    return await _handle_request(uksq, uksq.get_uk_sic_by_name, uk_sic_desc)

@app.get(
    "/V3.0/uk/sic/code/{uk_sic_code}",
    response_model=UKSICResponse,
    tags=["SIC - UK (V3.0)"],
    summary="Get UK SIC by code"
)
async def uk_sic_code(uk_sic_code: str = Path(..., description="UK SIC code")):
    return await _handle_request(uksq, uksq.get_uk_sic_by_code, uk_sic_code)
# END: UK Standard Industry Classification (SIC) database cache functions
# -------------------------------------------------------------- #

# -------------------------------------------------------------- #
# BEGIN: International Standard Industry Classification (ISIC) database cache functions
@app.get(
    "/V3.0/international/sic/section/{section_code}",
    response_model=ISICResponse,
    tags=["SIC - International (V3.0)"],
    summary="Get ISIC section by code"
)
async def international_sic_section(section_code: str = Path(..., description="ISIC section code")):
    return await _handle_request(isicsq, isicsq.get_section_by_code, section_code)

@app.get(
    "/V3.0/international/sic/division/{division_code}",
    response_model=ISICResponse,
    tags=["SIC - International (V3.0)"],
    summary="Get ISIC division by code"
)
async def international_sic_division(division_code: str = Path(..., description="Division code")):
    return await _handle_request(isicsq, isicsq.get_division_by_code, division_code)

@app.get(
    "/V3.0/international/sic/group/{group_code}",
    response_model=ISICResponse,
    tags=["SIC - International (V3.0)"],
    summary="Get ISIC group by code"
)
async def international_sic_group(group_code: str = Path(..., description="Group code")):
    return await _handle_request(isicsq, isicsq.get_group_by_code, group_code)

@app.get(
    "/V3.0/international/sic/class/{class_code}",
    response_model=ISICResponse,
    tags=["SIC - International (V3.0)"],
    summary="Get ISIC class by code"
)
async def international_sic_class(class_code: str = Path(..., description="ISIC class code")):
    return await _handle_request(isicsq, isicsq.get_class_by_code, class_code)

@app.get(
    "/V3.0/international/sic/description/{class_desc}",
    response_model=ISICResponse,
    tags=["SIC - International (V3.0)"],
    summary="Get ISIC by description"
)
async def international_sic_class_description(class_desc: str = Path(..., min_length=2, description="Industry description")):
    return await _handle_request(isicsq, isicsq.get_class_by_description, class_desc)
# END: International Standard Industry Classification (ISIC) database cache functions
# -------------------------------------------------------------- #

# -------------------------------------------------------------- #
# BEGIN: EU Standard Industry Classification (NACE) database cache functions
@app.get(
    "/V3.0/eu/sic/section/{section_code}",
    response_model=EUSICResponse,
    tags=["SIC - EU/NACE (V3.0)"],
    summary="Get EU NACE section by code"
)
async def eu_sic_section(section_code: str = Path(..., description="NACE section code")):
    return await _handle_request(eusicsq, eusicsq.get_section_by_code, section_code)

@app.get(
    "/V3.0/eu/sic/division/{division_code}",
    response_model=EUSICResponse,
    tags=["SIC - EU/NACE (V3.0)"],
    summary="Get EU NACE division by code"
)
async def eu_sic_division(division_code: str = Path(..., description="EU NACE division code")):
    return await _handle_request(eusicsq, eusicsq.get_division_by_code, division_code)

@app.get(
    "/V3.0/eu/sic/group/{group_code}",
    response_model=EUSICResponse,
    tags=["SIC - EU/NACE (V3.0)"],
    summary="Get EU NACE group by code"
)
async def eu_sic_group(group_code: str = Path(..., description="NACE group code")):
    return await _handle_request(eusicsq, eusicsq.get_group_by_code, group_code)

@app.get(
    "/V3.0/eu/sic/class/{class_code}",
    response_model=EUSICResponse,
    tags=["SIC - EU/NACE (V3.0)"],
    summary="Get EU NACE by class code"
)
async def eu_sic_class(class_code: str = Path(..., description="NACE class code")):
    return await _handle_request(eusicsq, eusicsq.get_class_by_code, class_code)

@app.get(
    "/V3.0/eu/sic/description/{class_desc}",
    response_model=EUSICResponse,
    tags=["SIC - EU/NACE (V3.0)"],
    summary="Get EU NACE by description"
)
async def eu_sic_class_description(class_desc: str = Path(..., min_length=2, description="Class description")):
    return await _handle_request(eusicsq, eusicsq.get_class_by_description, class_desc)
# END: EU Standard Industry Classification (NACE) database cache functions
# -------------------------------------------------------------- #

# -------------------------------------------------------------- #
# BEGIN: Japan Standard Industry Classification database cache functions
async def japan_sic_division(request):
    return await _handle_request(request, japansicsq, japansicsq.get_division_by_code, 'division_code')

async def japan_sic_major_group(request):
    return await _handle_request(request, japansicsq, japansicsq.get_major_group_by_code, 'major_group_code')

async def japan_sic_group(request):
    return await _handle_request(request, japansicsq, japansicsq.get_group_by_code, 'group_code')

async def japan_sic_industry_group(request):
    return await _handle_request(request, japansicsq, japansicsq.get_industry_group_by_code, 'industry_code')

async def japan_sic_industry_group_description(request):
    return await _handle_request(request, japansicsq, japansicsq.get_industry_group_by_description, 'industry_desc')
# END: Japan Standard Industry Classification database cache functions
# -------------------------------------------------------------- #

# -------------------------------------------------------------- #
# BEGIN: Unified Standard Industry Classification database cache functions
async def unified_sic_description(request):
    return await _handle_request(request, unified_sic_q, unified_sic_q.search_all_descriptions, 'query_string')

# END: Unified Standard Industry Classification database cache functions
# -------------------------------------------------------------- #

# -------------------------------------------------------------- #
# BEGIN: EDGAR dabase cache functions
async def edgar_detail(request):
    return await _handle_request(request, eq, eq.get_all_details, 'company_name')

async def edgar_summary(request):
    return await _handle_request(request, eq, eq.get_all_details, 'company_name', firmographics=False)

async def edgar_ciks(request):
    return await _handle_request(request, eq, eq.get_all_ciks, 'company_name')

async def edgar_firmographics(request):
    return await _handle_request(request, eq, eq.get_firmographics, 'cik_no')
# END: EDGAR dabase cache functions
# -------------------------------------------------------------- #

# -------------------------------------------------------------- #
# BEGIN: Wikipedia functions
async def wikipedia_firmographics(request):
    return await _handle_request(request, wq, wq.get_firmographics, 'company_name')
# END: Wikipedia functions
# -------------------------------------------------------------- #

# -------------------------------------------------------------- #
# BEGIN: General query functions
# 
async def general_query(request):
    return await _handle_request(request, gq, gq.get_firmographics, 'company_name')

# END: General query functions
# -------------------------------------------------------------- #

# -------------------------------------------------------------- #
# BEGIN: Helper functions
def _check_status_and_return(result_data, resource_name):
    """Check status code and return appropriate response"""
    return_code = result_data.get('code')
    result_count = result_data.get('total')
    return_msg = result_data.get('message')
    if return_code != 200:
        logger.error(f'There were [{result_count}] results for resource [{resource_name}].')
        raise HTTPException(
            status_code=return_code,
            detail=return_msg or f"Error retrieving {resource_name}"
        )
    return result_data

async def _handle_request(handler, func, query_value, *args, **kwargs):
    """Generic request handler for all endpoints"""
    handler.query = query_value
    
    # If the function is async, await it, otherwise call it directly
    if asyncio.iscoroutinefunction(func):
        data = await func(*args, **kwargs)
    else:
        data = func(*args, **kwargs)
        
    checked_data = _check_status_and_return(data, query_value)
    return checked_data
# END: Helper functions
# -------------------------------------------------------------- #

# -------------------------------------------------------------- #
# BEGIN: Define query objects
sq = SICQueries()
eq = EdgarQueries()
wq = WikipediaQueries()
gq = GeneralQueries()
uksq = UKSICQueries()
isicsq = InternationalSICQueries()
eusicsq = EuSICQueries()
japansicsq = JapanSICQueries()
unified_sic_q = UnifiedSICQueries()
# END: Define query objects
# -------------------------------------------------------------- #

# -------------------------------------------------------------- #
# BEGIN: Initialize FastAPI app
app = FastAPI(
    title="company_dns API",
    description="Company firmographics and SIC code lookup service",
    version="3.2.0",
    docs_url="/docs",
    redoc_url="/redoc",
    openapi_url="/openapi.json",
)

# Add CORS middleware
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["GET", "POST", "OPTIONS"],
    allow_headers=["*"],
    allow_credentials=True,
    expose_headers=["Content-Type", "X-Custom-Header"]
)

# Add security middleware
app.middleware("http")(security_middleware)

# Add logging middleware
app.middleware("http")(logging_middleware)

# Add rate limiting
app.state.limiter = limiter
app.add_exception_handler(RateLimitExceeded, rate_limit_error_handler)

# Add custom 404 handler (no more catch-all redirects)
@app.exception_handler(404)
async def not_found_handler(request: Request, exc):
    return JSONResponse(
        status_code=404,
        content={
            "detail": "Endpoint not found",
            "code": 404,
            "path": str(request.url.path),
            "help": "Visit /docs for API documentation"
        }
    )

def get_abs_path(relative_path):
    """Convert relative paths to absolute paths based on script location"""
    base_dir = PathLib(__file__).resolve().parent
    return os.path.join(base_dir, relative_path)
# END: Initialize FastAPI app
# -------------------------------------------------------------- #



if __name__ == "__main__": 
    try:
        # In development (local)
        if os.environ.get('ENVIRONMENT') == 'dev':
            host = '127.0.0.1'
        else:
            # In production (container)
            host = '0.0.0.0'  # Accept connections from any IP
            
        uvicorn.run(
            app, 
            host=host,
            port=8000, 
            log_level='info',
            access_log=True
        )
    except KeyboardInterrupt:
        logger.info("Server was shut down by the user.")